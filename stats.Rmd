---
title: "Presentation Station Indignation"
author: "Sara Herbst"
date: "2025-09-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cool Stats

```{r deps}
library(lme4)
library(boot) 
library(emmeans)
library(pbkrtest)
library(lmerTest)
library(ggplot2)
library(dplyr)
library(tidyr)
```

```{r read}

v1_df <- read.csv(file = "df_stats_v1_filtered.csv", sep = ";") 
head(v1_df)
```

```{r analysis}
m <- lmer(log(count) ~ (age * region) + (1|mouse), data=v1_df)
summary(m)
```

```{r emmeans}
# Estimated marginal means on log scale
emm <- emmeans(m, ~ age * region)

# Back-transform to counts
emm_counts <- summary(emm, type = "response")

print(emm_counts)
```

```{r plot}

# Set up dodge manually
age_levels <- levels(df_plot$age)
n_age <- length(age_levels)
dodge_width <- 0.4

df_plot <- df_plot %>%
  group_by(region) %>%
  mutate(
    x_num = as.numeric(region),
    age_idx = as.numeric(age),
    dodge_offset = (age_idx - (n_age + 1)/2) * dodge_width,
    x_pos = x_num + dodge_offset
  )

# Needle half-width
needle_half_width <- 0.1

# Vertical expected counts plot
ggplot(df_plot) +
  # CI ribbons
  geom_linerange(aes(ymin = lower.CL, ymax = upper.CL,
                     x = x_pos, color = age),
                 size = 6, alpha = 0.3) +
  # Needles = point estimates
  geom_segment(aes(x = x_pos - needle_half_width,
                   xend = x_pos + needle_half_width,
                   y = response, yend = response,
                   color = age),
               size = 0.8) +
  scale_x_continuous(breaks = 1:length(levels(df_plot$region)),
                     labels = levels(df_plot$region)) +
  labs(y = "Expected count", x = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("skyblue", "salmon")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r fold}
fold_df <- contrast(
  emm,
  method = "revpairwise",
  by = "region",
  type = "response",
  adjust = "none"
) %>%
  summary(infer = TRUE, type = "response") %>%
  as.data.frame() %>%
  rename(
    fold_change = ratio,
    fold_lower  = lower.CL,
    fold_upper  = upper.CL
  ) %>%
  mutate(x = as.numeric(factor(region)))

# ----------------------------
# Plot fold-change
# ----------------------------
needle_half_width <- 0.1

ggplot(fold_df, aes(x = x)) +
  # Ribbon = 95% CI
  geom_linerange(aes(ymin = fold_lower, ymax = fold_upper),
                 size = 6, alpha = 0.3, color = "skyblue") +
  # Needle = point estimate
  geom_segment(aes(x = x - needle_half_width,
                   xend = x + needle_half_width,
                   y = fold_change, yend = fold_change),
               size = 0.8, color = "skyblue") +
  # Reference line at 1
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
  # x-axis labels
  scale_x_continuous(breaks = fold_df$x, labels = fold_df$region) +
  labs(y = "Fold-change (p13 / p7)", x = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
