---
title: "Presentation Station Indignation"
author: "Sara Herbst"
date: "2025-09-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cool Stats

```{r deps}
library(lme4)
library(boot) 
library(emmeans)
library(pbkrtest)
library(lmerTest)
library(ggplot2)
library(dplyr)
library(tidyr)
```

```{r read}

v1_df <- read.csv(file = "df_stats_v1_filtered.csv", sep = ";") 
head(v1_df)
```

```{r analysis}
m <- lmer(log(count) ~ (age * region) + (1|mouse), data=v1_df)
summary(m)
```

```{r emmeans}
# Estimated marginal means on log scale
emm <- emmeans(m, ~ age * region)

# Back-transform to counts
emm_counts <- summary(emm, type = "response")

print(emm_counts)
```

```{r plot}

# Set up dodge manually
age_levels <- levels(df_plot$age)
n_age <- length(age_levels)
dodge_width <- 0.4

df_plot <- df_plot %>%
  group_by(region) %>%
  mutate(
    x_num = as.numeric(region),
    age_idx = as.numeric(age),
    dodge_offset = (age_idx - (n_age + 1)/2) * dodge_width,
    x_pos = x_num + dodge_offset
  )

# Needle half-width
needle_half_width <- 0.1

# Vertical expected counts plot
ggplot(df_plot) +
  # CI ribbons
  geom_linerange(aes(ymin = lower.CL, ymax = upper.CL,
                     x = x_pos, color = age),
                 size = 6, alpha = 0.3) +
  # Needles = point estimates
  geom_segment(aes(x = x_pos - needle_half_width,
                   xend = x_pos + needle_half_width,
                   y = response, yend = response,
                   color = age),
               size = 0.8) +
  scale_x_continuous(breaks = 1:length(levels(df_plot$region)),
                     labels = levels(df_plot$region)) +
  labs(y = "Expected count", x = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("skyblue", "salmon")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r fold}

# Age levels
age_levels <- levels(df_plot$age)

# Compute fold-change per region
fold_df <- df_plot %>%
  pivot_wider(
    id_cols = region,
    names_from = age,
    values_from = c(response, lower.CL, upper.CL),
    names_glue = "{.value}_{age}"
  ) %>%
  mutate(
    fold_change = .data[[paste0("response_", age_levels[2])]] /
                  .data[[paste0("response_", age_levels[1])]],
    fold_lower  = .data[[paste0("lower.CL_", age_levels[2])]] /
                  .data[[paste0("lower.CL_", age_levels[1])]],
    fold_upper  = .data[[paste0("upper.CL_", age_levels[2])]] /
                  .data[[paste0("upper.CL_", age_levels[1])]]
  )

# Needle half-width
needle_half_width <- 0.1

# Vertical fold-change plot
ggplot(fold_df, aes(x = region)) +
  # Ribbon = CI
  geom_linerange(aes(ymin = fold_lower, ymax = fold_upper),
                 size = 6, alpha = 0.3, color = "skyblue") +
  # Needle = fold-change
  geom_segment(aes(x = as.numeric(region) - needle_half_width,
                   xend = as.numeric(region) + needle_half_width,
                   y = fold_change, yend = fold_change),
               size = 0.8, color = "skyblue") +
  # Reference line at y = 1
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
  labs(y = "Fold-change (old / young)", x = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
